<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Db2 Query: Bob Cozzi's Db2JSON Example HTML App</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/style.css">
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0" defer></script>
</head>

<body>
    <h1>Db2 Query for DB2JSON</h1>
    <form id="sqlForm" method="post" enctype="multipart/form-data" autocomplete="off" spellcheck="true">
        <div class="sql-label-row">
            <label for="sqlInput">Type SQL or select from history:</label>
            <button type="submit" class="run-sql-btn" title="Run the SQL statement at the cursor">Run SQL</button>
            <input type="hidden" id="submitMode" name="submitMode" value="POST_MULTIPART">
        </div>

        <div class="sqlInput-copy-wrapper">
            <div class="history-row">
                <select id="sqlHistoryDropdown" title="SQL History"></select>
                <button id="editSqlHistoryBtn" type="button" class="link-btn" title="Open History Editor">Edit History
                </button>
                <button id="clearSqlHistoryBtn" type="button" class="link-btn danger"
                    title="Clear saved SQL history">Clear History</button>
            </div>

            <div class="sql-textarea-row">
                <div class="textarea-btn-container">
                    <textarea id="sqlInput" name="q" rows="6" cols="80" autocomplete="off" autocorrect="off"
                        spellcheck="false" data-gramm="false" data-enable-grammarly="false"></textarea>

                    <div class="textarea-toolbar" role="toolbar" aria-label="SQL editor tools">
                        <!-- Open -->
                        <button id="openSqlFileBtn" type="button" class="tool-btn icon-open" title="Open SQL File..."
                            aria-label="Open SQL File"></button>

                        <!-- Save -->
                        <button id="saveSqlBtn" type="button" class="tool-btn icon-save" title="Save SQL to file"
                            aria-label="Save" disabled></button>

                        <!-- Save As -->
                        <button id="saveSqlFileBtn" type="button" class="tool-btn icon-saveas" title="Save SQL as..."
                            aria-label="Save SQL as"></button>

                        <!-- Copy (original markup preserved for checkmark feedback) -->
                        <button id="copySqlInputBtn" type="button" class="tool-btn copy-sql-btn"
                            title="Copy SQL to clipboard" aria-label="Copy SQL to clipboard">
                            <span class="copy-icon-wrapper">
                                <svg class="copy-icon tool-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                                    <rect x="5" y="3" width="11" height="14" rx="2" fill="#fff" stroke="#555"
                                        stroke-width="1.5" />
                                    <rect x="2.5" y="6" width="11" height="11" rx="2" fill="#f5f5f5" stroke="#bbb"
                                        stroke-width="1.2" />
                                </svg>
                                <span class="copy-checkmark-feedback"></span>
                            </span>
                            <span class="copy-sql-btn-label">Copy</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Hidden file input for Open fallback (Firefox/Safari and non-secure contexts) -->
    <input id="sqlFileInput" type="file" accept=".sql,.txt" hidden />

    <div class="results-area">
        <div id="copyBtnRow" class="copy-table-btn-row is-hidden">
            <div id="resultsMeta" class="results-meta"></div>
            <button id="copyBtnTable" type="button" class="copy-table-btn" title="Copy entire table to clipboard">Copy
                Table</button>
            <button id="copyBtnPage" type="button" class="copy-table-btn" title="Copy current page to clipboard">Copy
                Page</button>
            <label for="copyBtnOption" class="visually-hidden">Format</label>
            <select id="copyBtnOption" name="copyStyle" class="copy-table-btn" title="Copy format">
                <option value="tab">Tab</option>
                <option value="comma">Comma (CSV)</option>
                <option value="pipe">Pipe |</option>
            </select>

        </div>
        <div id="error" role="status" aria-live="polite"></div>
        <div id="results">
            <div class="scroll-table-wrapper"></div>
        </div>
    </div>

    <!-- History Edit Modal -->
    <div id="historyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="historyModalTitle">
        <div class="modal-content">
            <h3 id="historyModalTitle">Edit SQL History</h3>
            <p class="modal-help">Type or paste statements. Separate statements with an unquoted semicolon (;) like in
                the SQL textarea. Newlines inside quotes are preserved.</p>
            <textarea id="historyTextarea" rows="12" placeholder="Examples:
            -- Single-line
            SELECT * FROM QIWS.QCUSTCDT;

            -- Multi-line (semicolon ends the statement)
            WITH X AS (
                SELECT *
                FROM SYSIBM.SYSDUMMY1
            );
            SELECT CURRENT_DATE
            FROM X;
            "></textarea>

            <div class="modal-actions">
                <span class="button_Align_Left">
                    <button id="historyDedupeBtn" type="button"
                        title="Immediately removes duplicate SQL statements from browser history (case-insensitive)">Remove
                        Duplicates</button>
                </span>
                <span class="button_Align_Right">
                    <button id="historyCancelBtn" type="button">Cancel</button>
                    <button id="historySaveBtn" type="button">Save</button>
                </span>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        // Place at bottom so DOM elements exist when assigning versioned URLs
        // Dev: append ?v=Date.now() automatically
        // Prod: omit ?v= to allow normal caching (or pass ?dev=1 to force busting)
        const qs = location.search;
        const isDev = /(?:^|[?&])(dev|cachebust|nocache)=1(?:&|$)/.test(qs) ||
            location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        // const ver = isDev ? String(Date.now()) : null;
        const ver = String(Date.now());
        const withV = (path) => ver ? `${path}?v=${ver}` : path;
        // Dynamically load CSS after the DataTables CSS
        function loadCss(href) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
        }
        loadCss(withV('css/db2query.css'));

        function loadScript(src, cb) {
            const s = document.createElement('script');
            s.src = src;
            s.onload = cb;
            document.body.appendChild(s);
        }

        loadScript(withV('js/db2query_sqlFmt.js'), () => {
            loadScript(withV('js/db2query_sqlHist.js'), () => {
                loadScript(withV('js/db2query.js'));
            });
        });
    </script>
</body>

</html>