<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob Cozzi's Db2JSON Test Composer using SQL</title>

    <link id="db2JSON_maincss" rel="stylesheet" href="css/db2json.css">
    <script id="db2JSON_sqlfmtjs"></script>
    <script id="db2JSON_sqlhistjs"></script>
    <script id="db2JSON_mainjs"></script>
</head>

<body>
    <h1>DB2JSON Query</h1>
    <form id="sqlForm" method="post" enctype="multipart/form-data" autocomplete="off" spellcheck="true">
        <div class="sql-label-row">
            <label for="sqlInput">Type SQL or select from history:</label>
            <button type="submit" class="run-sql-btn" title="Run the current SQL statement at the cursor">Run
                SQL</button>
            <input type="hidden" id="submitMode" name="submitMode" value="POST_MULTIPART">
        </div>

        <div class="sqlInput-copy-wrapper">
            <div class="history-row">
                <select id="sqlHistoryDropdown" title="SQL History"></select>
                <button id="editSqlHistoryBtn" type="button" class="link-btn" title="Open History Editor">Edit History
                </button>
                <button id="clearSqlHistoryBtn" type="button" class="link-btn danger"
                    title="Clear saved SQL history">Clear History</button>
            </div>

            <div class="sql-textarea-row">
                <div class="textarea-btn-container">
                    <textarea id="sqlInput" name="q" rows="6" cols="80"
                            autocomplete="off"
                            autocorrect="off"
                            spellcheck="false"
                            data-gramm="false"
                            data-enable-grammarly="false"></textarea>

                    <div class="textarea-toolbar" role="toolbar" aria-label="SQL editor tools">
                        <!-- Open -->
                        <button id="openSqlFileBtn" type="button" class="tool-btn icon-open" title="Open SQL File..." aria-label="Open SQL File"></button>

                        <!-- Save -->
                        <button id="saveSqlBtn" type="button" class="tool-btn icon-save" title="Save SQL to file" aria-label="Save" disabled></button>

                        <!-- Save As -->
                        <button id="saveSqlFileBtn" type="button" class="tool-btn icon-saveas" title="Save SQL as..." aria-label="Save SQL as"></button>

                        <!-- Copy (original markup preserved for checkmark feedback) -->
                        <button id="copySqlInputBtn" type="button" class="tool-btn copy-sql-btn"
                                title="Copy SQL to clipboard" aria-label="Copy SQL to clipboard">
                            <span class="copy-icon-wrapper">
                                <svg class="copy-icon tool-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                     xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                                    <rect x="5" y="3" width="11" height="14" rx="2" fill="#fff" stroke="#555" stroke-width="1.5" />
                                    <rect x="2.5" y="6" width="11" height="11" rx="2" fill="#f5f5f5" stroke="#bbb" stroke-width="1.2" />
                                </svg>
                                <span class="copy-checkmark-feedback"></span>
                            </span>
                            <span class="copy-sql-btn-label">Copy</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Hidden file input for Open fallback (Firefox/Safari and non-secure contexts) -->
    <input id="sqlFileInput" type="file" accept=".sql,.txt" hidden />

    <div class="results-area">
        <div id="error"></div>
        <div class="copy-table-btn-row">
            <button id="copyTableBtn" type="button" class="copy-table-btn is-hidden"
                title="Copy resultSet to clipboard (for pasting into Excel or Sheets)">Copy ResultSet</button>
        </div>
        <div id="results"></div>
    </div>

    <!-- History Edit Modal -->
    <div id="historyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="historyModalTitle">
        <div class="modal-content">
            <h3 id="historyModalTitle">Edit SQL History</h3>
            <p class="modal-help">Type or paste statements. Separate statements with an unquoted semicolon (;) like in
                the SQL textarea. Newlines inside quotes are preserved.</p>
            <textarea id="historyTextarea" rows="12" placeholder="Examples:
            -- Single-line
            SELECT * FROM QIWS.QCUSTCDT;

            -- Multi-line (semicolon ends the statement)
            WITH X AS (
                SELECT *
                FROM SYSIBM.SYSDUMMY1
            );
            SELECT CURRENT_DATE
            FROM X;
            "></textarea>

            <div class="modal-actions">
                <button id="historySaveBtn" type="button">Save</button>
                <button id="historyCancelBtn" type="button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        // Place at bottom so DOM elements exist when assigning versioned URLs
        // Dev: append ?v=Date.now() automatically
        // Prod: omit ?v= to allow normal caching (or pass ?dev=1 to force busting)
        const qs = location.search;
        const isDev = /(?:^|[?&])(dev|cachebust|nocache)=1(?:&|$)/.test(qs) ||
            location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        // const ver = isDev ? String(Date.now()) : null;
        const ver = String(Date.now());
        const withV = (path) => ver ? `${path}?v=${ver}` : path;

        const mainCSS = document.getElementById('db2JSON_maincss');
        const mainjs = document.getElementById('db2JSON_mainjs');
        const fmtJS = document.getElementById('db2JSON_sqlfmtjs');
        const histJS = document.getElementById('db2JSON_sqlhistjs');
        console.log(`mainjs=${withV('js/db2json.js')}`);

        if (mainCSS) mainCSS.href = withV('css/db2json.css');
        if (fmtJS) fmtJS.src = withV('js/db2json_sqlFmt.js');
        if (histJS) histJS.src = withV('js/db2json_sqlHist.js');
        if (mainjs) mainjs.src = withV('js/db2json.js');
    </script>
</body>

</html>